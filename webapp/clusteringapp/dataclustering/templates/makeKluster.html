{% extends "base.html" %}

{% block title %}
Create Cluster
{% endblock %}

{% block nav-makekluster %}
class="active"
{% endblock %}

{% block content %}


<article>

  <section>
    
  	   <h2> Create Kluster </h2>
      <br>
      <div class="clustering-form-container">
      <div class="clustering-form">

  	         <form role="form" id="createkluster" enctype="multipart/form-data">
            {% csrf_token %}

            <div class="form-group">

                <label for="fileInput">CSV File:</label>
                <input id="uploadbutton" class="form-control" type="file" value="Choose File" name="file" id="fileInput" accept="text/csv" />

            </div>

            <div class="form-group">

                <label for="linkagetype">Linkage Type:</label>
                    <select class="form-control" form="createkluster" name="linkagetype">
                         <option value="single" >Single </option>
                         <option value="complete">Complete</option>
                         <option value="average">Average</option>
                    </select>
            </div>

            <div class="form-group">
  	        

                <label for="map">Map Klustering:</label>
                <select class="form-control" form="createkluster" name="map">
                      <option value="no">No</option>
                     <option value="yes" >Yes </option>                 
                </select>

            </div>

            <div class="form-group">

                <label for="distanceMetric">Distance Metric:</label>
                <select class="form-control" form="createkluster" name="distanceMetric">
                     <option value="Euclidean" >Euclidean</option>
                     <option value="Pearson">Pearson Correlation</option>
                </select>

            </div>

            <div class="form-group">
              <button type="submit" onclick="createkluster()" class="btn btn-primary">Kluster</button>
            </div>

            </form>

            <script>
              function createkluster() {
                var form = document.getElementById('createkluster');
                var formData = new FormData(form);
                var http = new XMLHttpRequest();
                var url = "http://localhost/createkluster";
                http.open( "POST", url, false );
                http.send(formData);
                //http.send(null);
                //The response should be in json
                var rText = http.responseText;
                alert(rText);
                var response = JSON.parse(rText);
                var jsonCode = response.fields.JSON;
                var klusterCode = response.fields.code;
                var dType = response.fields.distanceMetric;
                alert(jsonCode);
                alert(klusterCode);
                alert(dType);
                // http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
                // http.setRequestHeader("Content-length", params.length);
                // http.setRequestHeader("Connection", "close");
                displayKluster(jsonCode);
                event.preventDefault();
              }
          </script>
      </div>
    </div>
  </section>
    
  <section>

    
    <div class="klusterView" id="dendrogram">
          <script>
          
            function displayKluster(jsonCode) {
              var hr = document.createElement("hr");
              var h2 = document.createElement("h2");
              h2.innerHTML = "Klustering Results";
          document.getElementById('dendrogram').appendChild(hr);
          document.getElementById('dendrogram').appendChild(h2);
              var width = 960,
    height = 700;
var cluster = d3.layout.cluster()
    .size([height, width - 100]);
var diagonal = d3.svg.diagonal()
    .projection(function(d) { return [x(d.y), d.x]; });
var svg = d3.select("#dendrogram").append("svg")
    .attr("width", width)
    .attr("height", height)
  .append("g")
    .attr("transform", "translate(50,40)");
var xs = [];   
var ys = [];   
function getXYfromJSONTree(node){           
   xs.push(node.x);          
   ys.push(node.y);           
   if(typeof node.children != 'undefined'){                   
      for ( j in node.children){                           
         getXYfromJSONTree(node.children[j]);                   
      }           
   }   
}   
var ymax = Number.MIN_VALUE;   
var ymin = Number.MAX_VALUE;   

   var root = JSON.parse(jsonCode);
   getXYfromJSONTree(root);
  var nodes = cluster.nodes(root),
      links = cluster.links(nodes);
   nodes.forEach( function(d,i){                   
      if(typeof xs[i] != 'undefined'){                           
         d.x = xs[i];                   
      }                   
      if(typeof ys[i] != 'undefined'){                           
         d.y = ys[i];                   
      }           
   });           
   nodes.forEach( function(d){                   
      if(d.y > ymax)
         ymax = d.y;
      if(d.y < ymin)                           
         ymin = d.y;           
   });           
   x = d3.scale.linear().domain([ymin, ymax]).range([0, width-100]);           
   xinv = d3.scale.linear().domain([ymax, ymin]).range([0, width-100]);   
  var link = svg.selectAll(".link")
      .data(links)
    .enter().append("path")
      .attr("class", "link")
      .attr("d", diagonal);
  var node = svg.selectAll(".node")
      .data(nodes)
    .enter().append("g")
      .attr("class", "node")
      .attr("transform", function(d) { return "translate(" + x(d.y) + "," + d.x + ")"; })
  node.append("circle")
      .attr("r", 4.5);
  node.append("text")
      .attr("dx", function(d) { return d.children ? -8 : 8; })
      .attr("dy", 3)
      .style("text-anchor", function(d) { return d.children ? "end" : "start"; })
      .text(function(d) { return d.name; });   

            }
          </script>
        </div>

  </section>

</article>

{% endblock %}

{% block footer %}

{% endblock %}
